<!DOCTYPE html> 
<html lang="en"> 
	<head> 
    	<title>EPub Reader</title> 
		<meta
		      name="viewport"
		      content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"
		    />
    	<script type="text/javascript" src="js-epub/js-epub.js"></script>
    	<script type="text/javascript" src="js-epub/vendor/js-unzip/js-unzip.js"></script>
    	<script type="text/javascript" src="js-epub/vendor/js-inflate/js-inflate.js"></script>
		<script type="text/javascript" src="http://monocle.inventivelabs.com.au/static/scripts/monocore.js"></script>
		<link rel="stylesheet" href="http://monocle.inventivelabs.com.au/static/styles/monocore.css" />
		<style type="text/css">
		      #reader {
		        top: 0;
		        left: 0;
		        right: 0;
		        bottom: 0;
		        position: absolute;
		        visibility: hidden;
		        overflow: hidden;
		      }
		      div.monelem_container {
		        background: #EEE;
		      }
		      div.monelem_page {
		        border: none;
		        box-shadow: #999 2px 0px 2px;
		        -moz-box-shadow: #999 2px 0px 2px;
		        -webkit-box-shadow: #999 2px 0px 2px;
		      }
		    </style>
  	</head> 
  	<body> 
    	<input type="file" id="book" name="book" multiple />
		<script type="text/javascript">
			
			function loadBook(event) {
				var file = event.target.files[0];
				
				var reader = new FileReader();
				reader.onloadend = function () {
	                showLoading(reader.result);
	            };            
	            reader.onerror = function (event) {
	                alert("An error occurred while reading the file. Error code: " + event.target.error.code);
	            };
	
	            reader.readAsBinaryString(file);
	
				var showLoading = function (blob) {
					var epub = new JSEpub(blob);
					epub.processInSteps(function (step, extras) {
					    console.log(step);

					    if (step === 1) {
					        console.log("Unzipping");
					    } else if (step === 2) {
					        console.log("Uncompressing " + extras);
					    } else if (step === 3) {
					        console.log("Reading OPF");
					    } else if (step === 4) {
					        console.log("Post processing");
					    } else if (step === 5) {
					        console.log("Finishing");
					        writeBook();
					    }

					});
					
					var writePage = function (page) {
					    var spine = epub.opf.spine[page];
						var href = epub.opf.manifest[spine]["href"];
						var doc = epub.files[href];
						
						document.getElementById('reader').innerHTML += doc.getElementsByTagName('body')[0].innerHTML;	
					};
					
					var writeBook = function() {
						for(i=0; i<epub.opf.spine.length; i++) {
							writePage(i);
						}
						
						
						var prep = function(rdr) {
						          document.getElementById('reader').style.visibility = "visible";
						}
						
						var init = function() {
						          window.reader = Monocle.Reader('reader', null, {}, prep);
						}
						
						init();
					}
				};				
				
			}
			
			document.getElementById('book').addEventListener('change', loadBook, false);
		</script>
		<div id="reader">
		</div>
  </body> 
</html>