<html lang="en"> 
	<head> 
    	<title>EPub Search</title> 
		<meta
		      name="viewport"
		      content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"
		    />
  	</head> 
  	<body> 
    	<input type="text" id="search" name="search" size="100" /><input type="button" name="click" id="click" value="Search!"/>
		<div id="reader">			
			<ul id="books"></ul>
		</div>
		<script type="text/javascript">
			var books = [];
			function search() {
				var name = document.getElementById('search').value;
				document.getElementById('click').disabled = true;
				document.getElementById('books').innerHTML = 'Searching for ' + name;
				
				var head= document.getElementsByTagName('head')[0];
				var script= document.createElement('script');
				script.type= 'text/javascript';
				script.src= "http://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20gutenberg%20where%20book%3D'" + name + "'%3B&format=json&diagnostics=false&env=store%3A%2F%2FNxDtaTrVncJG3ucjzRbGsp&callback=parseGoogleSearch";
				head.appendChild(script);				
			}
			
			function findEPub(index) {
				var url = books[index].url;
				
				var ePub,ePubImages;
				ePub = url + ".epub.noimages";
				ePubImages = url + ".epub.images";
				
				checkUrl(ePub, function(callbackUrl, res) {
					console.log(callbackUrl);
					if(res) {
						alert("There is a ePub without images");
					} else {
						alert("There is NOT ePub without images");
					}
				});
				
				checkUrl(ePubImages, function(callbackUrl, res) {
					console.log(callbackUrl);
					if(res) {
						alert("There is a ePub with images");
					} else {
						alert("There is NOT a ePub with images");
					}
				});
				
			}
			
			function checkUrl(url, callback) {
				var xmlhttp = new XMLHttpRequest();
				xmlhttp.open("HEAD", url,true);
			 	xmlhttp.onreadystatechange=function() {
				  if (xmlhttp.readyState==4) {
				   if (xmlhttp.status==200) callback(url, true);
				    else if (xmlhttp.status==404) callback(url, false);
				     else alert("Status is "+xmlhttp.status)
				  }
				}
			 	xmlhttp.send(null)
			}
			
			function parseGoogleSearch(data) {
				document.getElementById('click').disabled = false;
				if(data.query.results.books == null) {
					document.getElementById('books').innerHTML = "Sorry could not find it, search again";
					return;
				}
				
				if(data.query.results.books.book.hasOwnProperty('length')) { //array
					books = data.query.results.books.book;
				} else {
					//Single object
					books = [];
					books.push(data.query.results.books.book);
				}
				
				var ul = document.getElementById('books');
				for(var i in books) {
					ul.innerHTML += "<li><a href='#' onClick='javascript:findEPub(\"" + i + "\")'>" + books[i].title + "</a></li>";
				} 
				
				
			}			
			
			document.getElementById('click').addEventListener('click', search, false);			
		</script>	
  </body> 
</html>