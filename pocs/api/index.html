<html lang="en"> 
	<head> 
    	<title>EPub Search</title> 
		<meta
		      name="viewport"
		      content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"
		    />
  	</head> 
  	<body> 
    	<input type="text" id="search" name="search" size="100" /><input type="button" name="click" id="click" value="Search!"/>
		<div id="reader">			
			<ul id="books"></ul>
		</div>
		<script type="text/javascript">
			var books = [];
			function search() {
				var name = document.getElementById('search').value;
				document.getElementById('click').disabled = true;
				document.getElementById('books').innerHTML = 'Searching for ' + name;
				document.getElementById('reader').innerHTML = '<ul id="books"></ul>';
				
				var head= document.getElementsByTagName('head')[0];
				var script= document.createElement('script');
				script.type= 'text/javascript';
				script.src= "http://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20gutenberg%20where%20book%3D'" + name + "'%3B&format=json&diagnostics=false&env=store%3A%2F%2FNxDtaTrVncJG3ucjzRbGsp&callback=parseGoogleSearch";
				head.appendChild(script);				
			}
			
			function findEPub(index) {
				var url = books[index].url;
				
				var ePub,ePubImages, bookId;

				bookId = url.substring(url.lastIndexOf('/') + 1);
				url = url.replace('/ebooks/', '/cache/epub/');
				
				ePub = url + "/pg" + bookId + ".epub";
				ePubImages = url + "/pg" + bookId + "-images.epub";
				
				checkUrl(ePub, function(callbackUrl, res) {
					var reader = document.getElementById('reader');
					var p = document.createElement('p');
					if(res) {
						p.innerHTML = "<a href='" + callbackUrl +"'>ePub without images</a>";

					} else {
						p.innerHTML = "There is a not ePub without images (<a href='" + callbackUrl +"'>ePub without images</a>)";						
					}
					
					reader.appendChild(p);
				});
				
				checkUrl(ePubImages, function(callbackUrl, res) {
					var reader = document.getElementById('reader');
					var p = document.createElement('p');
					if(res) {
						p.innerHTML = "<a href='" + callbackUrl +"'>ePub images</a>";
					} else {
						p.innerHTML = "There is not a ePub without images (<a href='" + callbackUrl +"'>ePub images</a>)";
					}
					
					reader.appendChild(p);
				});
				
			}
			
			function checkUrl(url, callback) {
				var xmlhttp = new XMLHttpRequest();
				if(url.indexOf('?') != -1) {
					url += '&';
				} else {
					url += '?';
				}
				url += new Date().getTime();
				xmlhttp.open("HEAD", url,true);
				xmlhttp.onload = function(e) {
					if (this.status == 200) {
				    	if(xmlhttp.getResponseHeader('Content-Length') > 0) { //Not working cause ff has a problem with getResponseHeader and CORS
							callback(url, true);
						} else {
							callback(url, false);
						}
				  	} else {
						callback(url, false);
				  	}
				};

				xmlhttp.onerror = function() {
					callback(url, false);
				}
				
			 	xmlhttp.send(null);
			}
			
			function parseGoogleSearch(data) {
				document.getElementById('click').disabled = false;
				if(data.query.results.books == null) {
					document.getElementById('books').innerHTML = "Sorry could not find it, search again";
					return;
				}
				
				if(data.query.results.books.book.hasOwnProperty('length')) { //array
					books = data.query.results.books.book;
				} else {
					//Single object
					books = [];
					books.push(data.query.results.books.book);
				}
				
				var ul = document.getElementById('books');
				for(var i in books) {
					if(books[i].title.indexOf('-') != -1) {
						books[i].title = books[i].title.substring(0, books[i].title.lastIndexOf('-') - 1);
					}
					ul.innerHTML += "<li><a href='#' onClick='javascript:findEPub(\"" + i + "\")'>" + books[i].title + "</a></li>";
				} 
				
				
			}			
			
			document.getElementById('click').addEventListener('click', search, false);			
		</script>	
  </body> 
</html>